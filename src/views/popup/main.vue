<!-- eslint-disable no-console -->
<!-- eslint-disable no-alert -->
<script setup lang="ts">
import { goldBrickData, goldBrickTableData, goldBrickTableDataInit } from '~/logic/storage'

const goldBrickTableShowData = computed(() => goldBrickTableData.value.filter(raid => raid.quest_id !== '303141'))

function openOptionsPage() {
  chrome.runtime.openOptionsPage()
}

function resetData() {
  goldBrickTableData.value = goldBrickTableDataInit
  ElMessage.success('金本数据已重置')
}

function importData() {
  if (goldBrickData.value.length === 0)
    return ElMessage.info('当前没有可导入的数据')
  const re = /waaatanuki.[a-zA-Z]+.io\/gbf-app/

  chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => {
    if (tabs.length > 0 && tabs[0].id && tabs[0].url && re.test(tabs[0].url)) {
      chrome.tabs.sendMessage(tabs[0].id, { todo: 'importData' }).then((res) => {
        if (res?.isDone)
          goldBrickData.value = []
      })
    }
    else { alert('只能在gbfApp网站导入') }
  })
}

function exportData() {
  if (goldBrickData.value.length === 0)
    return ElMessage.info('当前没有可导出的数据')
  const exportData = goldBrickData.value.reduce((pre, cur) => {
    const val: any = { ...cur }
    delete val.battleId
    pre.push({ [cur.battleId]: val })
    return pre
  }, [] as any[])
  exportJSONFile(exportData)
  goldBrickData.value = []
  ElMessage.success('导出成功,并清空数据')
}

function exportJSONFile(itemList: any) {
  const data = JSON.stringify(itemList, null, 2)
  const content = new Blob([data])
  const urlObject = window.URL || window.webkitURL || window
  const url = urlObject.createObjectURL(content)
  const el = document.createElement('a')
  el.href = url
  el.download = 'gbfApp_金本统计数据.json'
  el.click()
  urlObject.revokeObjectURL(url)
}
</script>

<template>
  <div w-500px>
    <el-table :data="goldBrickTableShowData">
      <el-table-column prop="name" align="center">
        <template #header>
          <div
            class="icon-btn" m-auto dark:i-carbon-moon i-carbon-sun
            @click="toggleDark()"
          />
        </template>
        <template #default="{ row }">
          <img w-full m-auto :src="getImgSrc(row.quest_id)">
        </template>
      </el-table-column>
      <el-table-column prop="blueChest" align="center">
        <template #header="{ column }">
          <img w-30px m-auto :src="getImgSrc(column.property)">
        </template>
        <template #default="{ row }">
          <el-tooltip effect="dark" placement="top">
            <template #content>
              总次数：{{ row.total }}<br>
              蓝箱率：{{
                ((row.blueChest / row.total || 0) * 100).toFixed(1)
              }}%
            </template>
            {{ row.blueChest }}
          </el-tooltip>
        </template>
      </el-table-column>
      <el-table-column prop="goldBrick" align="center">
        <template #header="{ column }">
          <img w-30px m-auto :src="getImgSrc(column.property)">
        </template>
        <template #default="{ row }">
          <el-tooltip effect="dark" placement="top">
            <template #content>
              蓝箱金率：{{ ((row.goldBrick / row.blueChest || 0) * 100).toFixed(1) }}%
              <br>
              已经{{ row.lastBlueChestCount }}个蓝箱没出金
            </template>
            {{ row.goldBrick }}
          </el-tooltip>
        </template>
      </el-table-column>
      <el-table-column prop="ring3" align="center">
        <template #header="{ column }">
          <img w-30px m-auto :src="getImgSrc(column.property)">
        </template>
      </el-table-column>
      <el-table-column prop="ring2" align="center">
        <template #header="{ column }">
          <img w-30px m-auto :src="getImgSrc(column.property)">
        </template>
      </el-table-column>
      <el-table-column prop="ring1" align="center">
        <template #header="{ column }">
          <img w-30px m-auto :src="getImgSrc(column.property)">
        </template>
      </el-table-column>
    </el-table>
    <div flex justify-between>
      <div>
        <el-button m-2 size="small" type="danger" @click="resetData">
          <div mr-1 i-carbon:reset />
          重置
        </el-button>
      </div>
      <div>
        <el-button m-2 size="small" type="primary" @click="importData">
          <div mr-1 i-carbon:document-import />
          导入
        </el-button>
        <el-button m-2 size="small" type="primary" @click="exportData">
          <div mr-1 i-carbon:document-export />
          导出
        </el-button>
        <el-button m-2 size="small" type="primary" @click="openOptionsPage">
          <div mr-1 i-carbon:notebook />
          更多
        </el-button>
      </div>
    </div>
  </div>
</template>
